<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planner Personal (Admin)</title>
  <style>
    :root { font-family: system-ui, Arial; }
    body { margin: 16px; max-width: 1150px; }
    h1 { margin: 0 0 10px; }
    .muted { color:#666; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 14px; align-items:center; }
    .tabs button { padding:10px 12px; border:1px solid #ccc; background:#fff; border-radius:10px; cursor:pointer; }
    .tabs button.active { border-color:#111; }
    .card { border:1px solid #ddd; border-radius:14px; padding:14px; margin: 12px 0; }
    .grid { display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 760px){ .grid { grid-template-columns: 1fr; } }
    label { display:flex; flex-direction:column; gap:6px; font-size:14px; }
    input, select, textarea { padding:10px; border:1px solid #ccc; border-radius:10px; }
    textarea { min-height: 70px; resize: vertical; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { padding:10px 12px; border:1px solid #111; background:#111; color:#fff; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111; border-color:#ccc; }
    .btn.danger { background:#b00020; border-color:#b00020; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align: top; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .msg { padding:10px 12px; border-radius:12px; margin:10px 0; }
    .ok { background:#e8fff1; border:1px solid #b7f3cc; }
    .err { background:#ffecec; border:1px solid #ffc7c7; }
    .split { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .searchBox { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .searchBox input { min-width: 260px; }
    .subcard { border:1px dashed #ddd; border-radius:14px; padding:12px; margin-top:10px; }
    .toggle { display:flex; gap:8px; flex-wrap:wrap; }
    .toggle button { padding:10px 12px; border:1px solid #ccc; background:#fff; border-radius:10px; cursor:pointer; }
    .toggle button.active { border-color:#111; background:#111; color:#fff; }

    /* Amarillo para coincidencias de libres (2 en mismo sector/día/franja) */
    tr.warn td { background: #fff4b5; }
  </style>
</head>
<body>
  <h1>Planner (Horarios • Libres • Tareas)</h1>
  <div class="muted">Mantenimiento y Recepción — guarda datos en este dispositivo (localStorage).</div>

  <div id="msg"></div>

  <!-- BUSQUEDA EMPLEADO -->
  <div class="card">
    <h2>Buscar empleado</h2>
    <div class="searchBox">
      <input id="empSearch" placeholder="Buscar por nombre o apellido..." />
      <button class="btn secondary" id="clearSearch">Limpiar</button>
    </div>
    <div id="empResults" class="subcard" style="display:none"></div>
  </div>

  <div class="tabs">
    <button data-tab="personal" class="active">Personal</button>
    <button data-tab="turnos">Turnos</button>
    <button data-tab="libres">Días libres</button>
    <button data-tab="tareas">Tareas</button>
    <button id="exportBtn" class="secondary">Exportar JSON</button>
    <button id="importBtn" class="secondary">Importar JSON</button>
    <button id="resetBtn" class="danger">Reset</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>

  <!-- PERSONAL -->
  <section id="tab-personal" class="card">
    <h2>Personal</h2>
    <div class="grid">
      <label>Nombre
        <input id="p_name" placeholder="Ej: Juan" />
      </label>
      <label>Apellido
        <input id="p_last" placeholder="Ej: Pérez" />
      </label>
      <label>Sector
        <select id="p_sector">
          <option value="Mantenimiento">Mantenimiento</option>
          <option value="Recepción">Recepción</option>
        </select>
      </label>
      <label>Puesto / Rol
        <input id="p_role" placeholder="Ej: Auxiliar / Encargado / Recepcionista" />
      </label>
      <label>Teléfono (opcional)
        <input id="p_phone" placeholder="Ej: 09xxxxxxx" />
      </label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="savePersonBtn">Guardar</button>
      <button class="btn secondary" id="cancelPersonEdit" style="display:none">Cancelar edición</button>
      <span id="personMode" class="pill">Modo: Nuevo</span>
    </div>

    <div style="margin-top:14px">
      <table>
        <thead>
          <tr><th>Empleado</th><th>Sector</th><th>Puesto</th><th>Tel.</th><th>Acciones</th></tr>
        </thead>
        <tbody id="peopleTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- TURNOS -->
  <section id="tab-turnos" class="card" style="display:none">
    <h2>Turnos</h2>
    <div class="grid">
      <label>Persona
        <select id="t_person"></select>
      </label>
      <label>Sector
        <select id="t_sector">
          <option value="Mantenimiento">Mantenimiento</option>
          <option value="Recepción">Recepción</option>
        </select>
      </label>
      <label>Fecha
        <input id="t_date" type="date" />
      </label>
      <label>Inicio
        <input id="t_start" type="time" />
      </label>
      <label>Fin
        <input id="t_end" type="time" />
      </label>
      <label>Notas (opcional)
        <input id="t_note" placeholder="Ej: cubrir caja 12-14" />
      </label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveShiftBtn">Guardar turno</button>
      <button class="btn secondary" id="cancelShiftEdit" style="display:none">Cancelar edición</button>
      <span id="shiftMode" class="pill">Modo: Nuevo</span>
      <span class="muted">Regla: no permite turnos solapados (misma persona + mismo día).</span>
    </div>

    <div style="margin-top:14px">
      <table>
        <thead>
          <tr><th>Fecha</th><th>Persona</th><th>Sector</th><th>Horario</th><th>Notas</th><th>Acciones</th></tr>
        </thead>
        <tbody id="shiftsTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- LIBRES -->
  <section id="tab-libres" class="card" style="display:none">
    <h2>Días libres</h2>

    <div class="grid">
      <label>Persona
        <select id="l_person"></select>
      </label>

      <label>Estado
        <select id="l_status">
          <option value="Pendiente">Pendiente</option>
          <option value="Aprobado">Aprobado</option>
        </select>
      </label>

      <label>Día
        <input id="l_day" type="date" />
      </label>

      <label>Nota (opcional)
        <input id="l_note" placeholder="Ej: trámite, médico" />
      </label>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <div class="muted" style="margin-bottom:6px">Tipo</div>
        <div class="toggle">
          <button id="btnFullDay" class="active" type="button">Día entero</button>
          <button id="btnHalfDay" type="button">Medio horario</button>
        </div>
      </div>

      <div id="halfDayBlock" style="display:none">
        <div class="muted" style="margin-bottom:6px">Franja</div>
        <div class="toggle">
          <button id="btnMorning" class="active" type="button">Mañana</button>
          <button id="btnAfternoon" type="button">Tarde</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveLeaveBtn">Guardar</button>
      <button class="btn secondary" id="cancelLeaveEdit" style="display:none">Cancelar edición</button>
      <span id="leaveMode" class="pill">Modo: Nuevo</span>
      <span class="muted">Permite hasta 2 por sector en el mismo día/franja (coincidencias en amarillo).</span>
    </div>

    <div style="margin-top:14px">
      <table>
        <thead>
          <tr><th>Día</th><th>Persona</th><th>Sector</th><th>Tipo</th><th>Estado</th><th>Nota</th><th>Acciones</th></tr>
        </thead>
        <tbody id="leavesTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- TAREAS -->
  <section id="tab-tareas" class="card" style="display:none">
    <h2>Tareas</h2>
    <div class="grid">
      <label>Título
        <input id="k_title" placeholder="Ej: Revisar bomba piscina" />
      </label>
      <label>Sector
        <select id="k_sector">
          <option value="Mantenimiento">Mantenimiento</option>
          <option value="Recepción">Recepción</option>
        </select>
      </label>
      <label>Responsable
        <select id="k_person"></select>
      </label>
      <label>Vence
        <input id="k_due" type="date" />
      </label>
      <label>Prioridad
        <select id="k_prio">
          <option value="Alta">Alta</option>
          <option value="Media" selected>Media</option>
          <option value="Baja">Baja</option>
        </select>
      </label>
      <label>Estado
        <select id="k_status">
          <option value="Pendiente" selected>Pendiente</option>
          <option value="En curso">En curso</option>
          <option value="Hecha">Hecha</option>
        </select>
      </label>
      <label>Detalle (opcional)
        <textarea id="k_detail" placeholder="Notas para el equipo..."></textarea>
      </label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveTaskBtn">Guardar tarea</button>
      <button class="btn secondary" id="cancelTaskEdit" style="display:none">Cancelar edición</button>
      <span id="taskMode" class="pill">Modo: Nuevo</span>
    </div>

    <div style="margin-top:14px">
      <table>
        <thead>
          <tr><th>Vence</th><th>Tarea</th><th>Sector</th><th>Responsable</th><th>Prioridad</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tasksTbody"></tbody>
      </table>
    </div>
  </section>

<script>
  const KEY = "planner_mvp_v4";
  const state = load() ?? { people: [], shifts: [], leaves: [], tasks: [] };

  let editingPersonId = null;
  let editingShiftId = null;
  let editingLeaveId = null;
  let editingTaskId  = null;

  // Leaves UI state
  let leaveKind = "FULL";      // FULL | HALF
  let leaveHalfSlot = "AM";    // AM | PM

  // Permitir hasta 2 por sector/día/bloque (una coincidencia)
  const MAX_PER_SECTOR_BLOCK = 2;

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function showMsg(text, ok=true){
    const el = document.getElementById("msg");
    if(!text){ el.innerHTML=""; return; }
    el.innerHTML = `<div class="msg ${ok ? "ok" : "err"}">${text}</div>`;
    setTimeout(()=>{ el.innerHTML=""; }, 3500);
  }

  // Tabs
  document.querySelectorAll(".tabs button[data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tabs button[data-tab]").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      ["personal","turnos","libres","tareas"].forEach(t=>{
        document.getElementById(`tab-${t}`).style.display = (t===tab) ? "" : "none";
      });
      renderAll();
    });
  });

  // Helpers
  function fullName(p){ return `${p.name} ${p.lastName}`.trim(); }
  function personById(id){ return state.people.find(p=>p.id===id); }
  function personLabel(id){
    const p = personById(id);
    return p ? `${fullName(p)} — ${p.sector}` : "—";
  }

  function fillPeopleSelect(selectId, allowEmpty=false){
    const sel = document.getElementById(selectId);
    const cur = sel.value;
    sel.innerHTML = allowEmpty ? `<option value="">(Sin asignar)</option>` : "";
    state.people.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${fullName(p)} — ${p.sector}`;
      sel.appendChild(opt);
    });
    if([...sel.options].some(o=>o.value===cur)) sel.value = cur;
  }

  // Shift overlap
  function timeToMin(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }
  function overlaps(aStart, aEnd, bStart, bEnd){ return Math.max(aStart,bStart) < Math.min(aEnd,bEnd); }
  function hasShiftOverlap(personId, date, start, end, ignoreShiftId=null){
    const s1 = timeToMin(start), e1 = timeToMin(end);
    return state.shifts.some(s=>{
      if(ignoreShiftId && s.id===ignoreShiftId) return false;
      if(s.personId!==personId || s.date!==date) return false;
      const s2=timeToMin(s.start), e2=timeToMin(s.end);
      return overlaps(s1,e1,s2,e2);
    });
  }

  // Leaves blocks (FULL blocks AM+PM)
  function leaveBlocks(kind, slot){
    if(kind === "FULL") return ["AM","PM"];
    return [slot]; // HALF
  }

  // Reglas:
  // 1) Misma persona: NO puede solaparse en el mismo día/bloque.
  // 2) Por sector: permitir hasta MAX_PER_SECTOR_BLOCK por día/bloque.
  function validateLeave(personId, sector, day, kind, slot, ignoreLeaveId=null){
    const blocks = leaveBlocks(kind, slot);

    // 1) persona
    for(const l of state.leaves){
      if(ignoreLeaveId && l.id===ignoreLeaveId) continue;
      if(l.day !== day) continue;
      if(l.personId !== personId) continue;

      const existingBlocks = leaveBlocks(l.kind, l.halfSlot);
      if(existingBlocks.some(b => blocks.includes(b))){
        return { ok:false, reason:"Esa persona ya tiene libre/medio en ese día/franja." };
      }
    }

    // 2) sector (capacidad)
    for(const block of blocks){
      let count = 0;
      for(const l of state.leaves){
        if(ignoreLeaveId && l.id===ignoreLeaveId) continue;
        if(l.day !== day) continue;
        if(l.sector !== sector) continue;

        const existingBlocks = leaveBlocks(l.kind, l.halfSlot);
        if(existingBlocks.includes(block)) count++;
      }

      // si estoy editando, el registro actual está ignorado arriba.
      // si agrego nuevo y ya hay 2, no dejar.
      if(count >= MAX_PER_SECTOR_BLOCK){
        return { ok:false, reason:`En ${sector}, ya hay ${MAX_PER_SECTOR_BLOCK} libres/medios para ese día/franja.` };
      }
    }

    return { ok:true };
  }

  // Coincidencias para pintar amarillo (cuando count >= 2)
  function buildLeaveCoincidenceMap(){
    const map = new Map(); // key: sector|day|block -> count
    for(const l of state.leaves){
      const blocks = leaveBlocks(l.kind, l.halfSlot);
      for(const b of blocks){
        const key = `${l.sector}|${l.day}|${b}`;
        map.set(key, (map.get(key) || 0) + 1);
      }
    }
    return map;
  }

  // Render tables
  function renderPeople(){
    const tb = document.getElementById("peopleTbody");
    tb.innerHTML = "";
    state.people.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(fullName(p))}</b></td>
        <td><span class="pill">${escapeHtml(p.sector)}</span></td>
        <td>${escapeHtml(p.role || "—")}</td>
        <td>${escapeHtml(p.phone || "—")}</td>
        <td class="split">
          <button class="btn secondary" data-edit-person="${p.id}">Editar</button>
          <button class="btn danger" data-del-person="${p.id}">Eliminar</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderShifts(){
    const tb = document.getElementById("shiftsTbody");
    tb.innerHTML = "";
    const sorted = [...state.shifts].sort((a,b)=> (a.date+a.start).localeCompare(b.date+b.start));
    sorted.forEach(s=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.date}</td>
        <td>${escapeHtml(personLabel(s.personId))}</td>
        <td><span class="pill">${escapeHtml(s.sector)}</span></td>
        <td>${s.start} - ${s.end}</td>
        <td>${escapeHtml(s.note || "—")}</td>
        <td class="split">
          <button class="btn secondary" data-edit-shift="${s.id}">Editar</button>
          <button class="btn danger" data-del-shift="${s.id}">Eliminar</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function leaveTypeLabel(l){
    if(l.kind === "FULL") return "Día entero";
    return l.halfSlot === "AM" ? "Medio (Mañana)" : "Medio (Tarde)";
  }

  function renderLeaves(){
    const tb = document.getElementById("leavesTbody");
    tb.innerHTML = "";

    const coincidenceMap = buildLeaveCoincidenceMap();

    const sorted = [...state.leaves].sort((a,b)=> (a.day).localeCompare(b.day));
    sorted.forEach(l=>{
      const blocks = leaveBlocks(l.kind, l.halfSlot);

      // Se marca amarillo si cualquier bloque del registro tiene 2 o más en ese sector/día/bloque
      const isWarn = blocks.some(b => (coincidenceMap.get(`${l.sector}|${l.day}|${b}`) || 0) >= 2);

      const tr = document.createElement("tr");
      if(isWarn) tr.classList.add("warn");

      tr.innerHTML = `
        <td>${l.day}</td>
        <td>${escapeHtml(personLabel(l.personId))}</td>
        <td><span class="pill">${escapeHtml(l.sector)}</span></td>
        <td><span class="pill">${leaveTypeLabel(l)}</span></td>
        <td><span class="pill">${escapeHtml(l.status)}</span></td>
        <td>${escapeHtml(l.note || "—")}</td>
        <td class="split">
          <button class="btn secondary" data-edit-leave="${l.id}">Editar</button>
          <button class="btn danger" data-del-leave="${l.id}">Eliminar</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderTasks(){
    const tb = document.getElementById("tasksTbody");
    tb.innerHTML = "";
    const sorted = [...state.tasks].sort((a,b)=> (a.due||"9999-99-99").localeCompare(b.due||"9999-99-99"));
    sorted.forEach(k=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${k.due || "—"}</td>
        <td><b>${escapeHtml(k.title)}</b><div class="muted">${escapeHtml(k.detail ? k.detail.slice(0,70) : "")}</div></td>
        <td><span class="pill">${escapeHtml(k.sector)}</span></td>
        <td>${k.personId ? escapeHtml(personLabel(k.personId)) : "—"}</td>
        <td><span class="pill">${escapeHtml(k.prio)}</span></td>
        <td><span class="pill">${escapeHtml(k.status)}</span></td>
        <td class="split">
          <button class="btn secondary" data-edit-task="${k.id}">Editar</button>
          <button class="btn danger" data-del-task="${k.id}">Eliminar</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderAll(){
    fillPeopleSelect("t_person");
    fillPeopleSelect("l_person");
    fillPeopleSelect("k_person", true);
    renderPeople(); renderShifts(); renderLeaves(); renderTasks();
    renderEmployeeSearch();
  }

  // ----- PERSON -----
  function setPersonMode(editing){
    document.getElementById("personMode").textContent = `Modo: ${editing ? "Editar" : "Nuevo"}`;
    document.getElementById("cancelPersonEdit").style.display = editing ? "" : "none";
    document.getElementById("savePersonBtn").textContent = editing ? "Actualizar" : "Guardar";
  }
  function resetPersonForm(){
    editingPersonId = null;
    document.getElementById("p_name").value = "";
    document.getElementById("p_last").value = "";
    document.getElementById("p_sector").value = "Mantenimiento";
    document.getElementById("p_role").value = "";
    document.getElementById("p_phone").value = "";
    setPersonMode(false);
  }
  document.getElementById("cancelPersonEdit").addEventListener("click", resetPersonForm);

  document.getElementById("savePersonBtn").addEventListener("click", ()=>{
    const name = document.getElementById("p_name").value.trim();
    const lastName = document.getElementById("p_last").value.trim();
    const sector = document.getElementById("p_sector").value;
    const role = document.getElementById("p_role").value.trim();
    const phone = document.getElementById("p_phone").value.trim();

    if(!name || !lastName) return showMsg("Falta nombre y/o apellido.", false);

    if(editingPersonId){
      const p = personById(editingPersonId);
      if(!p) return showMsg("No encontré la persona a editar.", false);
      p.name = name; p.lastName = lastName; p.sector = sector; p.role = role; p.phone = phone;
      save(); renderAll(); resetPersonForm();
      showMsg("Empleado actualizado ✅");
    } else {
      state.people.push({ id: uid(), name, lastName, sector, role, phone });
      save(); renderAll(); resetPersonForm();
      showMsg("Empleado agregado ✅");
    }
  });

  // ----- SHIFT -----
  function setShiftMode(editing){
    document.getElementById("shiftMode").textContent = `Modo: ${editing ? "Editar" : "Nuevo"}`;
    document.getElementById("cancelShiftEdit").style.display = editing ? "" : "none";
    document.getElementById("saveShiftBtn").textContent = editing ? "Actualizar turno" : "Guardar turno";
  }
  function resetShiftForm(){
    editingShiftId = null;
    document.getElementById("t_date").value = "";
    document.getElementById("t_start").value = "";
    document.getElementById("t_end").value = "";
    document.getElementById("t_note").value = "";
    setShiftMode(false);
  }
  document.getElementById("cancelShiftEdit").addEventListener("click", resetShiftForm);

  document.getElementById("saveShiftBtn").addEventListener("click", ()=>{
    const personId = document.getElementById("t_person").value;
    const sector = document.getElementById("t_sector").value;
    const date = document.getElementById("t_date").value;
    const start = document.getElementById("t_start").value;
    const end = document.getElementById("t_end").value;
    const note = document.getElementById("t_note").value.trim();

    if(!personId) return showMsg("Elegí una persona.", false);
    if(!date || !start || !end) return showMsg("Faltan fecha y horas.", false);
    if(timeToMin(end) <= timeToMin(start)) return showMsg("La hora fin debe ser mayor a inicio.", false);
    if(hasShiftOverlap(personId, date, start, end, editingShiftId)) return showMsg("Se solapa con otro turno de esa persona.", false);

    if(editingShiftId){
      const s = state.shifts.find(x=>x.id===editingShiftId);
      if(!s) return showMsg("No encontré el turno a editar.", false);
      s.personId = personId; s.sector = sector; s.date = date; s.start = start; s.end = end; s.note = note;
      save(); renderAll(); resetShiftForm();
      showMsg("Turno actualizado ✅");
    } else {
      state.shifts.push({ id: uid(), personId, sector, date, start, end, note });
      save(); renderAll(); resetShiftForm();
      showMsg("Turno agregado ✅");
    }
  });

  // ----- LEAVES UI -----
  function setLeaveMode(editing){
    document.getElementById("leaveMode").textContent = `Modo: ${editing ? "Editar" : "Nuevo"}`;
    document.getElementById("cancelLeaveEdit").style.display = editing ? "" : "none";
    document.getElementById("saveLeaveBtn").textContent = editing ? "Actualizar" : "Guardar";
  }

  function syncLeaveUI(){
    document.getElementById("btnFullDay").classList.toggle("active", leaveKind==="FULL");
    document.getElementById("btnHalfDay").classList.toggle("active", leaveKind==="HALF");
    document.getElementById("halfDayBlock").style.display = leaveKind==="HALF" ? "" : "none";
    document.getElementById("btnMorning").classList.toggle("active", leaveHalfSlot==="AM");
    document.getElementById("btnAfternoon").classList.toggle("active", leaveHalfSlot==="PM");
  }

  document.getElementById("btnFullDay").addEventListener("click", ()=>{ leaveKind="FULL"; syncLeaveUI(); });
  document.getElementById("btnHalfDay").addEventListener("click", ()=>{ leaveKind="HALF"; syncLeaveUI(); });
  document.getElementById("btnMorning").addEventListener("click", ()=>{ leaveHalfSlot="AM"; syncLeaveUI(); });
  document.getElementById("btnAfternoon").addEventListener("click", ()=>{ leaveHalfSlot="PM"; syncLeaveUI(); });

  function resetLeaveForm(){
    editingLeaveId = null;
    document.getElementById("l_day").value = "";
    document.getElementById("l_note").value = "";
    document.getElementById("l_status").value = "Pendiente";
    leaveKind = "FULL";
    leaveHalfSlot = "AM";
    syncLeaveUI();
    setLeaveMode(false);
  }
  document.getElementById("cancelLeaveEdit").addEventListener("click", resetLeaveForm);

  document.getElementById("saveLeaveBtn").addEventListener("click", ()=>{
    const personId = document.getElementById("l_person").value;
    const status = document.getElementById("l_status").value;
    const day = document.getElementById("l_day").value;
    const note = document.getElementById("l_note").value.trim();

    if(!personId) return showMsg("Elegí una persona.", false);
    if(!day) return showMsg("Elegí un día.", false);

    const p = personById(personId);
    if(!p) return showMsg("No encontré a la persona.", false);

    const sector = p.sector;
    const kind = leaveKind;
    const halfSlot = (kind==="HALF") ? leaveHalfSlot : "";

    const validation = validateLeave(personId, sector, day, kind, leaveHalfSlot, editingLeaveId);
    if(!validation.ok) return showMsg(validation.reason, false);

    if(editingLeaveId){
      const l = state.leaves.find(x=>x.id===editingLeaveId);
      if(!l) return showMsg("No encontré el registro a editar.", false);
      l.personId = personId;
      l.sector = sector;
      l.day = day;
      l.kind = kind;
      l.halfSlot = halfSlot;
      l.status = status;
      l.note = note;
      save(); renderAll(); resetLeaveForm();
      showMsg("Libre actualizado ✅");
    } else {
      state.leaves.push({
        id: uid(),
        personId,
        sector,
        day,
        kind,
        halfSlot,
        status,
        note
      });
      save(); renderAll(); resetLeaveForm();
      showMsg("Libre agregado ✅");
    }
  });

  // ----- TASKS -----
  function setTaskMode(editing){
    document.getElementById("taskMode").textContent = `Modo: ${editing ? "Editar" : "Nuevo"}`;
    document.getElementById("cancelTaskEdit").style.display = editing ? "" : "none";
    document.getElementById("saveTaskBtn").textContent = editing ? "Actualizar tarea" : "Guardar tarea";
  }
  function resetTaskForm(){
    editingTaskId = null;
    document.getElementById("k_title").value = "";
    document.getElementById("k_due").value = "";
    document.getElementById("k_detail").value = "";
    document.getElementById("k_sector").value = "Mantenimiento";
    document.getElementById("k_prio").value = "Media";
    document.getElementById("k_status").value = "Pendiente";
    document.getElementById("k_person").value = "";
    setTaskMode(false);
  }
  document.getElementById("cancelTaskEdit").addEventListener("click", resetTaskForm);

  document.getElementById("saveTaskBtn").addEventListener("click", ()=>{
    const title = document.getElementById("k_title").value.trim();
    const sector = document.getElementById("k_sector").value;
    const personId = document.getElementById("k_person").value;
    const due = document.getElementById("k_due").value;
    const prio = document.getElementById("k_prio").value;
    const status = document.getElementById("k_status").value;
    const detail = document.getElementById("k_detail").value.trim();

    if(!title) return showMsg("Falta título de tarea.", false);

    if(editingTaskId){
      const t = state.tasks.find(x=>x.id===editingTaskId);
      if(!t) return showMsg("No encontré la tarea a editar.", false);
      t.title = title; t.sector = sector; t.personId = personId; t.due = due; t.prio = prio; t.status = status; t.detail = detail;
      save(); renderAll(); resetTaskForm();
      showMsg("Tarea actualizada ✅");
    } else {
      state.tasks.push({ id: uid(), title, sector, personId, due, prio, status, detail });
      save(); renderAll(); resetTaskForm();
      showMsg("Tarea agregada ✅");
    }
  });

  // Delegated actions (edit/delete)
  document.body.addEventListener("click", (e)=>{
    const delP = e.target.dataset.delPerson;
    const editP = e.target.dataset.editPerson;
    const delS = e.target.dataset.delShift;
    const editS = e.target.dataset.editShift;
    const delL = e.target.dataset.delLeave;
    const editL = e.target.dataset.editLeave;
    const delT = e.target.dataset.delTask;
    const editT = e.target.dataset.editTask;

    if(delP){
      if(!confirm("¿Eliminar empleado y sus datos asociados?")) return;
      state.people = state.people.filter(p=>p.id!==delP);
      state.shifts = state.shifts.filter(s=>s.personId!==delP);
      state.leaves = state.leaves.filter(l=>l.personId!==delP);
      state.tasks.forEach(t=>{ if(t.personId===delP) t.personId=""; });
      save(); renderAll();
      if(editingPersonId===delP) resetPersonForm();
      showMsg("Empleado eliminado.");
    }
    if(editP){
      const p = personById(editP);
      if(!p) return;
      editingPersonId = p.id;
      document.getElementById("p_name").value = p.name;
      document.getElementById("p_last").value = p.lastName;
      document.getElementById("p_sector").value = p.sector;
      document.getElementById("p_role").value = p.role || "";
      document.getElementById("p_phone").value = p.phone || "";
      setPersonMode(true);
      showMsg("Editando empleado…");
    }

    if(delS){
      if(!confirm("¿Eliminar turno?")) return;
      state.shifts = state.shifts.filter(s=>s.id!==delS);
      save(); renderAll();
      if(editingShiftId===delS) resetShiftForm();
      showMsg("Turno eliminado.");
    }
    if(editS){
      const s = state.shifts.find(x=>x.id===editS);
      if(!s) return;
      editingShiftId = s.id;
      document.getElementById("t_person").value = s.personId;
      document.getElementById("t_sector").value = s.sector;
      document.getElementById("t_date").value = s.date;
      document.getElementById("t_start").value = s.start;
      document.getElementById("t_end").value = s.end;
      document.getElementById("t_note").value = s.note || "";
      setShiftMode(true);
      showMsg("Editando turno…");
    }

    if(delL){
      if(!confirm("¿Eliminar libre/medio?")) return;
      state.leaves = state.leaves.filter(l=>l.id!==delL);
      save(); renderAll();
      if(editingLeaveId===delL) resetLeaveForm();
      showMsg("Registro eliminado.");
    }
    if(editL){
      const l = state.leaves.find(x=>x.id===editL);
      if(!l) return;
      editingLeaveId = l.id;

      document.getElementById("l_person").value = l.personId;
      document.getElementById("l_status").value = l.status;
      document.getElementById("l_day").value = l.day;
      document.getElementById("l_note").value = l.note || "";

      leaveKind = l.kind || "FULL";
      leaveHalfSlot = (l.halfSlot === "PM") ? "PM" : "AM";
      syncLeaveUI();

      setLeaveMode(true);
      showMsg("Editando libre…");
    }

    if(delT){
      if(!confirm("¿Eliminar tarea?")) return;
      state.tasks = state.tasks.filter(t=>t.id!==delT);
      save(); renderAll();
      if(editingTaskId===delT) resetTaskForm();
      showMsg("Tarea eliminada.");
    }
    if(editT){
      const t = state.tasks.find(x=>x.id===editT);
      if(!t) return;
      editingTaskId = t.id;
      document.getElementById("k_title").value = t.title;
      document.getElementById("k_sector").value = t.sector;
      document.getElementById("k_person").value = t.personId || "";
      document.getElementById("k_due").value = t.due || "";
      document.getElementById("k_prio").value = t.prio;
      document.getElementById("k_status").value = t.status;
      document.getElementById("k_detail").value = t.detail || "";
      setTaskMode(true);
      showMsg("Editando tarea…");
    }
  });

  // Search employee card
  function renderEmployeeSearch(){
    const q = document.getElementById("empSearch").value.trim().toLowerCase();
    const box = document.getElementById("empResults");
    if(!q){ box.style.display="none"; box.innerHTML=""; return; }

    const matches = state.people.filter(p => `${p.name} ${p.lastName}`.toLowerCase().includes(q));

    if(matches.length===0){
      box.style.display = "";
      box.innerHTML = `<b>No hay resultados</b> para “${escapeHtml(q)}”.`;
      return;
    }

    if(matches.length===1){
      box.style.display = "";
      box.innerHTML = employeeCard(matches[0]);
      return;
    }

    box.style.display = "";
    box.innerHTML = `
      <b>Resultados (${matches.length})</b><br/>
      ${matches.map(p=>`<div style="margin-top:8px">
        <button class="btn secondary" data-open-emp="${p.id}">Ver: ${escapeHtml(fullName(p))}</button>
      </div>`).join("")}
    `;
  }

  function employeeCard(p){
    const shifts = state.shifts.filter(s=>s.personId===p.id).sort((a,b)=>(a.date+a.start).localeCompare(b.date+b.start));
    const leaves = state.leaves.filter(l=>l.personId===p.id).sort((a,b)=>a.day.localeCompare(b.day));
    const tasks  = state.tasks.filter(t=>t.personId===p.id).sort((a,b)=>(a.due||"9999").localeCompare(b.due||"9999"));

    return `
      <div>
        <div class="row">
          <div><b>${escapeHtml(fullName(p))}</b> <span class="pill">${escapeHtml(p.sector)}</span></div>
          <div class="muted">${escapeHtml(p.role || "")}</div>
        </div>

        <div style="margin-top:10px" class="grid">
          <div class="subcard">
            <b>Horarios (Turnos)</b>
            ${shifts.length ? `<ul>${shifts.map(s=>`<li>${s.date} — ${s.start}-${s.end} <span class="pill">${escapeHtml(s.sector)}</span> ${s.note?`<span class="muted">(${escapeHtml(s.note)})</span>`:""}</li>`).join("")}</ul>` : `<div class="muted">Sin turnos.</div>`}
          </div>
          <div class="subcard">
            <b>Libres / Medios</b>
            ${leaves.length ? `<ul>${leaves.map(l=>`<li>${l.day} — <span class="pill">${leaveTypeLabel(l)}</span> <span class="pill">${escapeHtml(l.status)}</span> ${l.note?`<span class="muted">(${escapeHtml(l.note)})</span>`:""}</li>`).join("")}</ul>` : `<div class="muted">Sin registros.</div>`}
          </div>
          <div class="subcard" style="grid-column: 1 / -1;">
            <b>Tareas</b>
            ${tasks.length ? `<ul>${tasks.map(t=>`<li>${t.due?`${t.due} — `:""}<b>${escapeHtml(t.title)}</b> <span class="pill">${escapeHtml(t.prio)}</span> <span class="pill">${escapeHtml(t.status)}</span> ${t.detail?`<span class="muted">(${escapeHtml(t.detail)})</span>`:""}</li>`).join("")}</ul>` : `<div class="muted">Sin tareas asignadas.</div>`}
          </div>
        </div>
      </div>
    `;
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  document.getElementById("empSearch").addEventListener("input", renderEmployeeSearch);
  document.getElementById("clearSearch").addEventListener("click", ()=>{
    document.getElementById("empSearch").value = "";
    renderEmployeeSearch();
  });

  document.body.addEventListener("click", (e)=>{
    const openEmp = e.target.dataset.openEmp;
    if(openEmp){
      const p = personById(openEmp);
      if(!p) return;
      const box = document.getElementById("empResults");
      box.style.display = "";
      box.innerHTML = employeeCard(p);
    }
  });

  // Export / Import / Reset
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "planner_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importBtn").addEventListener("click", ()=>{
    document.getElementById("importFile").click();
  });

  document.getElementById("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data.people || !data.shifts || !data.leaves || !data.tasks) throw new Error("Formato inválido");
      state.people = data.people; state.shifts = data.shifts; state.leaves = data.leaves; state.tasks = data.tasks;
      save(); renderAll();
      resetPersonForm(); resetShiftForm(); resetLeaveForm(); resetTaskForm();
      showMsg("Importado ✅");
    }catch{
      showMsg("No se pudo importar (archivo inválido).", false);
    }finally{
      e.target.value = "";
    }
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(!confirm("¿Seguro? Borra todo en este dispositivo.")) return;
    state.people = []; state.shifts = []; state.leaves = []; state.tasks = [];
    save(); renderAll();
    resetPersonForm(); resetShiftForm(); resetLeaveForm(); resetTaskForm();
    showMsg("Reset listo.");
  });

  // Init modes
  setPersonMode(false);
  setShiftMode(false);
  setLeaveMode(false);
  setTaskMode(false);
  syncLeaveUI();
  renderAll();
</script>
</body>
</html>

